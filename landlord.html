<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Landlord Dashboard ‚Äî InzuLink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="description" content="Manage your listings, promotion, and subscription plan on InzuLink." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@phosphor-icons/web" defer></script>

  <!-- Shared navbar styles -->
  <link rel="stylesheet" href="./assets/app.css" />

  <style>
    :root{
      --primary:#0f172a;
      --accent:#f59e0b;
      --accent-hover:#d97706;
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 18px 35px rgba(2,6,23,0.10);

      --success:#10b981;
      --success-bg:#f0fdf4;
      --danger:#dc2626;
      --danger-bg:#fef2f2;
      --warn:#f59e0b;
      --warn-bg:#fffbeb;
    }

    body{ margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); }

    .wrap{
      width:min(1200px, 92%);
      margin:0 auto;
      padding: 18px 0 46px;
    }

    .top{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .title{
      margin:0;
      font-size: clamp(1.45rem, 2.8vw, 2.1rem);
      font-weight: 900;
      letter-spacing:-0.6px;
      color: var(--primary);
    }
    .sub{
      margin:6px 0 0;
      color: var(--muted);
      font-weight: 650;
      line-height:1.6;
      max-width: 820px;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-left:auto;
    }

    .btn{
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      cursor:pointer;
      font-weight: 900;
      font-size: 0.92rem;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-primary:hover{ background:#1e293b; }
    .btn-accent{ background: var(--accent); color:#111827; }
    .btn-accent:hover{ background: var(--accent-hover); }
    .btn-outline{ background:#fff; color:var(--primary); border-color: var(--border); }
    .btn-outline:hover{ background:#f1f5f9; border-color:#cbd5e1; }
    .btn-disabled{
      background:#94a3b8 !important;
      color:#e2e8f0 !important;
      cursor:not-allowed !important;
      pointer-events:none !important;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .banner{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
    }

    .plan-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 0.82rem;
      border: 1px solid var(--border);
      background:#f1f5f9;
      color:#475569;
      text-transform: uppercase;
      letter-spacing:.4px;
    }
    .plan-pill.pro{
      background: var(--success-bg);
      border-color: #bbf7d0;
      color:#16a34a;
    }

    .note{
      color: var(--muted);
      font-weight: 650;
      line-height: 1.6;
    }
    .note b{ color: var(--primary); }

    .list{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 16px;
    }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(2,6,23,0.06);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .h{
      margin:0;
      font-size: 1.05rem;
      font-weight: 900;
      color: var(--primary);
      letter-spacing:-0.3px;
      line-height:1.25;
    }

    .meta{
      margin-top:6px;
      color: var(--muted);
      font-weight: 650;
      font-size: 0.92rem;
      line-height:1.55;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      border-top:1px solid #f1f5f9;
      padding-top: 12px;
    }

    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing:.4px;
      border:1px solid var(--border);
      background:#f1f5f9;
      color:#475569;
    }
    .status.ok{ background: var(--success-bg); border-color:#bbf7d0; color:#16a34a; }
    .status.sold{ background: var(--danger-bg); border-color:#fecaca; color:#dc2626; }

    .miniBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .iconBtn{
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#475569;
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .iconBtn:hover{ background:#f1f5f9; border-color:#cbd5e1; }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn.danger:hover{ background: var(--danger-bg); border-color:#fecaca; color: var(--danger); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      color:#92400e;
      font-weight: 900;
      font-size: 0.86rem;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background:#fef3c7; }
    .chip.muted{
      border-color: var(--border);
      background:#f1f5f9;
      color:#64748b;
      cursor:default;
    }
    .chip.good{
      border-color:#bbf7d0;
      background: var(--success-bg);
      color:#16a34a;
      cursor:default;
    }

    .empty{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 38px 18px;
      text-align:center;
    }
    .empty i{ font-size: 3.6rem; color:#e2e8f0; }
    .empty h2{ margin: 10px 0 8px; color: var(--primary); font-weight: 900; letter-spacing:-0.4px; }
    .empty p{ margin:0; color: var(--muted); font-weight: 650; line-height:1.7; }

    /* Modals */
    .overlay{
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(2,6,23,0.60);
      z-index: 2100;
      padding: 18px;
    }
    .modal{
      width:min(520px, 96vw);
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px;
      position: relative;
    }
    .close{
      position:absolute;
      top: 10px; right: 10px;
      width: 40px; height: 40px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color:#475569;
    }
    .close:hover{ background:#f1f5f9; }

    .mTitle{ margin: 6px 0 8px; font-size: 1.15rem; font-weight: 900; color: var(--primary); letter-spacing:-0.3px; }
    .mText{ margin: 0 0 14px; color: var(--muted); font-weight: 650; line-height:1.7; }

    .momoBox{
      background:#fff7ed;
      border: 1px solid #fdba74;
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 12px;
      color:#7c2d12;
      font-weight: 800;
      line-height: 1.6;
    }
    .code{
      display:block;
      margin-top:10px;
      padding: 12px;
      border-radius: 14px;
      border: 2px dashed #cbd5e1;
      background:#fff;
      font-weight: 900;
      color: var(--primary);
      letter-spacing: .5px;
      text-align:center;
    }

    .field{ display:grid; gap:6px; margin-top: 10px; }
    label{ font-size:.85rem; font-weight: 900; color:#475569; }
    .input{
      width:100%;
      padding: 12px;
      border-radius: 12px;
      border:1px solid #cbd5e1;
      outline:none;
      font-family: inherit;
    }
    .input:focus{
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15,23,42,0.10);
    }

    .mBtns{ display:flex; gap:10px; margin-top: 14px; }
    .mBtns .btn{ flex:1; justify-content:center; }

    footer{
      margin-top: 18px;
      background: var(--primary);
      border-radius: 22px;
      padding: 22px 16px;
      color:#94a3b8;
      text-align:center;
    }
    footer a{ color:#94a3b8; font-weight:800; text-decoration:none; }
    footer a:hover{ color:#fff; }
  </style>

  <script>
    // Guard: must be logged in and Landlord
    (function(){
      let u = null;
      try { u = JSON.parse(localStorage.getItem("user")); } catch(_) {}
      if (!u || u.role !== "Landlord") {
        window.location.replace("login.html?next=landlord.html");
      }
    })();
  </script>
</head>

<body>
  <!-- Shared navbar -->
  <div id="appNavbar"></div>

  <main class="wrap">
    <section class="top" aria-label="Landlord header">
      <div>
        <h1 class="title">My Properties</h1>
        <p class="sub">Manage listings, status (Available/Sold), and promotions. Keep your listings accurate to build trust.</p>
      </div>

      <div class="actions">
        <a class="btn btn-outline" href="feed.html"><i class="ph ph-globe"></i> Browse Feed</a>
        <a class="btn btn-accent" id="postBtn" href="post-property.html"><i class="ph ph-plus-circle"></i> Post Property</a>
        <button class="btn btn-primary" type="button" onclick="init(true)"><i class="ph ph-arrows-clockwise"></i> Refresh</button>
      </div>
    </section>

    <section class="grid">
      <!-- Plan banner -->
      <div class="banner" aria-label="Plan banner">
        <div>
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span class="plan-pill" id="planPill">FREE ACCOUNT</span>
            <span class="note" id="planNote">Limit: <b id="limitText">4 active posts</b></span>
          </div>
          <div class="note" style="margin-top:8px;">
            Pro agents get: <b>Unlimited posts</b> + <b>Verified badge</b> + more trust.
          </div>
        </div>

        <button class="btn btn-primary" id="upgradeBtn" type="button" onclick="openProModal()">
          <i class="ph ph-trophy"></i> Upgrade to Pro
        </button>
      </div>

      <!-- Properties list -->
      <div id="propArea">
        <div style="text-align:center; padding:28px; color:#94a3b8; font-weight:900;">Loading properties...</div>
      </div>

      <footer>
        ¬© 2026 InzuLink ‚Ä¢ <a href="contract.html">Contract Tool</a>
      </footer>
    </section>
  </main>

  <!-- PRO MODAL -->
  <div class="overlay" id="proModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Upgrade to Pro">
      <button class="close" onclick="closeAllModals()">‚úï</button>
      <div class="mTitle">Become a Pro Agent üèÜ</div>
      <div class="mText">Post unlimited properties, get ‚ÄúVerified Agent‚Äù status, and boost trust with seekers.</div>

      <div class="momoBox">
        <div><strong>1) Send 10,000 RWF</strong> via MoMo to the code below:</div>
        <span class="code">*182*8*1*174118#</span>
        <div style="font-size:.9rem; color:#7c2d12; margin-top:8px;">
          Recipient: <strong>Ephrem</strong>
        </div>
      </div>

      <div class="field">
        <label for="proPayerPhone">2) Phone used to pay</label>
        <input class="input" id="proPayerPhone" placeholder="078..." />
      </div>

      <div class="mBtns">
        <button class="btn btn-outline" type="button" onclick="closeAllModals()">Cancel</button>
        <button class="btn btn-primary" type="button" onclick="submitProPayment()"><i class="ph ph-check-circle"></i> Confirm</button>
      </div>
    </div>
  </div>

  <!-- FEATURE MODAL -->
  <div class="overlay" id="featModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Promote property">
      <button class="close" onclick="closeAllModals()">‚úï</button>
      <div class="mTitle" style="color:var(--accent);">Promote this Property</div>
      <div class="mText">Get more views by adding a featured badge (Gold) on the feed.</div>

      <div class="momoBox">
        <div><strong>1) Send 5,000 RWF</strong> via MoMo:</div>
        <span class="code">*182*8*1*174118#</span>
      </div>

      <div class="field">
        <label for="featPayerPhone">2) Phone used to pay</label>
        <input class="input" id="featPayerPhone" placeholder="078..." />
      </div>

      <div class="mBtns">
        <button class="btn btn-outline" type="button" onclick="closeAllModals()">Cancel</button>
        <button class="btn btn-primary" type="button" onclick="submitFeaturePayment()"><i class="ph ph-rocket-launch"></i> Confirm</button>
      </div>
    </div>
  </div>

  <!-- Shared navbar script -->
  <script src="./assets/navbar.js"></script>

  <script>
    const API_BASE = (localStorage.getItem("API_BASE") || "https://inzulink-v1.onrender.com").replace(/\/$/, "");
    let user = null;
    try { user = JSON.parse(localStorage.getItem("user")); } catch(_) {}

    const propArea = document.getElementById("propArea");
    const planPill = document.getElementById("planPill");
    const limitText = document.getElementById("limitText");
    const upgradeBtn = document.getElementById("upgradeBtn");
    const postBtn = document.getElementById("postBtn");

    let selectedPropId = null;

    function money(v){
      const n = Number(v || 0);
      if (!Number.isFinite(n)) return "RWF 0";
      return "RWF " + n.toLocaleString("en-RW");
    }
    function safe(v){ return (v === null || v === undefined) ? "" : String(v); }

    async function fetchWithTimeout(url, options = {}, timeoutMs = 15000){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }

    function openProModal(){
      document.getElementById("proModal").style.display = "flex";
      document.getElementById("proModal").setAttribute("aria-hidden", "false");
    }
    function openFeatModal(propertyId){
      selectedPropId = Number(propertyId);
      document.getElementById("featPayerPhone").value = "";
      document.getElementById("featModal").style.display = "flex";
      document.getElementById("featModal").setAttribute("aria-hidden", "false");
    }
    function closeAllModals(){
      ["proModal","featModal"].forEach(id => {
        const el = document.getElementById(id);
        el.style.display = "none";
        el.setAttribute("aria-hidden","true");
      });
    }

    async function submitProPayment(){
      const phone = (document.getElementById("proPayerPhone").value || "").trim();
      if (!phone) return alert("Enter the phone number used for payment.");

      // Uses your server simulation endpoint (works for demos)
      try{
        await fetchWithTimeout(`${API_BASE}/api/payment/pay`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            userId: user.id,
            amount: 10000,
            phoneNumber: phone,
            type: "ProSubscription",
            propertyId: 0
          })
        }, 20000);

        // Update local session for UI immediately
        user.plan = "Pro";
        localStorage.setItem("user", JSON.stringify(user));
        closeAllModals();
        await init(true);

        alert("Payment Successful! You are now a PRO Agent.");

      } catch(_){
        alert("Payment failed or server unreachable. Try again.");
      }
    }

    async function submitFeaturePayment(){
      const phone = (document.getElementById("featPayerPhone").value || "").trim();
      if (!phone) return alert("Enter the phone number used for payment.");
      if (!selectedPropId) return alert("No property selected.");

      try{
        await fetchWithTimeout(`${API_BASE}/api/payment/pay`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            userId: user.id,
            amount: 5000,
            phoneNumber: phone,
            type: "PropertyBoost",
            propertyId: selectedPropId
          })
        }, 20000);

        closeAllModals();
        await init(true);
        alert("Payment Successful! Property is now Featured.");

      } catch(_){
        alert("Promotion request failed or server unreachable. Try again.");
      }
    }

    async function setStatus(propertyId, nextStatus){
      try{
        const res = await fetchWithTimeout(`${API_BASE}/api/properties/${Number(propertyId)}/status`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ status: nextStatus })
        });

        if (!res.ok) throw new Error("Failed");
        await init(true);
      } catch(_){
        alert("Could not update status. Please try again.");
      }
    }

    async function deleteProp(propertyId){
      if (!confirm("Delete this property permanently?")) return;

      try{
        const res = await fetchWithTimeout(`${API_BASE}/api/properties/${Number(propertyId)}`, { method:"DELETE" });
        if (!res.ok) throw new Error("Failed");
        await init(true);
      } catch(_){
        alert("Could not delete. Please try again.");
      }
    }

    function renderEmpty(){
      propArea.innerHTML = `
        <div class="empty">
          <i class="ph ph-house-line"></i>
          <h2>No properties yet</h2>
          <p>Click ‚ÄúPost Property‚Äù to add your first listing.</p>
          <div style="margin-top:18px;">
            <a class="btn btn-accent" href="post-property.html"><i class="ph ph-plus-circle"></i> Post Property</a>
          </div>
        </div>
      `;
    }

    function renderList(props){
      const cards = props.map(p => {
        const id = Number(p.property_id || p.id);
        const title = safe(p.title || "Property");
        const location = [p.sector, p.district].filter(Boolean).join(", ") || safe(p.district || "Rwanda");
        const price = money(p.price_per_month ?? p.price ?? 0);

        const status = safe(p.status || "Available");
        const isAvailable = status === "Available";
        const isFeatured = !!p.is_featured;
        const promo = safe(p.promotion_status || "");

        // Promotion chip
        let promoEl = "";
        if (isFeatured) {
          promoEl = `<span class="chip good"><i class="ph ph-star-fill"></i> Featured</span>`;
        } else if (promo === "Pending") {
          promoEl = `<span class="chip muted">‚è≥ Verifying‚Ä¶</span>`;
        } else {
          promoEl = `<span class="chip" onclick="openFeatModal(${id})"><i class="ph ph-rocket-launch"></i> Promote</span>`;
        }

        return `
          <article class="card">
            <div class="cardTop">
              <div>
                <h3 class="h">${title}</h3>
                <div class="meta">üìç ${safe(location)} ‚Ä¢ <b style="color:var(--primary);">${price}</b></div>
              </div>
              <div class="status ${isAvailable ? "ok" : "sold"}">
                <i class="ph ${isAvailable ? "ph-check-circle" : "ph-x-circle"}"></i> ${safe(status)}
              </div>
            </div>

            <div class="row">
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                ${promoEl}
                <span class="note">Views: <b>${Number(p.views_count || 0)}</b></span>
              </div>

              <div class="miniBtns">
                ${
                  isAvailable
                    ? `<button class="iconBtn" title="Mark as Sold" onclick="setStatus(${id}, 'Sold')"><i class="ph ph-seal-warning"></i></button>`
                    : `<button class="iconBtn" title="Mark Available" onclick="setStatus(${id}, 'Available')"><i class="ph ph-check"></i></button>`
                }
                <button class="iconBtn danger" title="Delete" onclick="deleteProp(${id})"><i class="ph ph-trash"></i></button>
              </div>
            </div>
          </article>
        `;
      }).join("");

      propArea.innerHTML = `<div class="list">${cards}</div>`;
    }

    async function init(force=false){
      // Update plan UI
      const isPro = (user?.plan === "Pro");
      planPill.textContent = isPro ? "PRO AGENT" : "FREE ACCOUNT";
      planPill.className = "plan-pill" + (isPro ? " pro" : "");
      limitText.textContent = isPro ? "Unlimited posts" : "4 active posts";
      upgradeBtn.style.display = isPro ? "none" : "inline-flex";

      // Load properties
      propArea.innerHTML = `<div style="text-align:center; padding:28px; color:#94a3b8; font-weight:900;">Loading properties...</div>`;

      try{
        const res = await fetchWithTimeout(`${API_BASE}/api/my-properties/${user.id}`, {}, 15000);
        const props = await res.json().catch(() => []);
        if (!res.ok) throw new Error("Failed");

        const list = Array.isArray(props) ? props : [];

        // Enforce Free plan limit (4 Available)
        const activeCount = list.filter(p => (p.status === "Available")).length;
        if (!isPro && activeCount >= 4) {
          postBtn.classList.add("btn-disabled");
          postBtn.innerHTML = `<i class="ph ph-lock-key"></i> Limit Reached (4/4)`;
          postBtn.setAttribute("href", "javascript:void(0)");
        } else {
          postBtn.classList.remove("btn-disabled");
          postBtn.innerHTML = `<i class="ph ph-plus-circle"></i> Post Property`;
          postBtn.setAttribute("href", "post-property.html");
        }

        if (list.length === 0) return renderEmpty();
        renderList(list);

      } catch(err){
        propArea.innerHTML = `
          <div class="empty" style="border-color:#fecaca;">
            <i class="ph ph-warning-circle" style="color:#fecaca;"></i>
            <h2 style="color:#991b1b;">Could not load your properties</h2>
            <p>Check your server or API_BASE, then try again.</p>
            <div style="margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="init(true)"><i class="ph ph-arrows-clockwise"></i> Retry</button>
              <a class="btn btn-outline" href="feed.html"><i class="ph ph-globe"></i> Browse Feed</a>
            </div>
            <div style="margin-top:10px; color:#94a3b8; font-weight:800;">
              Tip: <code style="background:#f1f5f9; border:1px solid #e2e8f0; padding:6px 8px; border-radius:10px;">localStorage.setItem("API_BASE","https://YOUR-BACKEND.onrender.com")</code>
            </div>
          </div>
        `;
      }
    }

    // Close modals when clicking outside
    ["proModal","featModal"].forEach(id => {
      document.getElementById(id).addEventListener("click", (e) => {
        if (e.target.id === id) closeAllModals();
      });
    });

    window.addEventListener("load", () => init());
  </script>
</body>
</html>
