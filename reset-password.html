<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>Reset Password — InzuLink</title>

  <meta name="description" content="Reset your InzuLink password using a secure token." />
  <meta name="robots" content="noindex,follow" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@phosphor-icons/web" defer></script>

  <!-- Shared navbar styles -->
  <link rel="stylesheet" href="./assets/app.css" />

  <style>
    :root{
      --primary:#0f172a;
      --bg:#f8fafc;
      --text:#0b1220;
      --muted:#64748b;
      --card:#ffffff;
      --border:#e2e8f0;
      --shadow: 0 18px 35px rgba(2,6,23,0.10);

      --danger:#dc2626;
      --danger-bg:#fef2f2;
      --success:#16a34a;
      --success-bg:#f0fdf4;
      --warn:#f59e0b;
      --warn-bg:#fffbeb;
    }

    body{ margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:var(--text); }

    .wrap{ width:min(760px, 92%); margin:0 auto; padding:18px 0 38px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:26px 22px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      border:1px solid #fde68a; background:#fffbeb; color:#92400e;
      font-weight:900; font-size:.85rem;
    }

    h1{
      margin:14px 0 8px;
      font-size:1.9rem;
      letter-spacing:-.7px;
      color:var(--primary);
      font-weight:900;
    }

    .sub{
      margin:0 0 18px;
      color:var(--muted);
      line-height:1.7;
      font-weight:600;
    }

    .msg{
      display:none;
      border-radius:14px;
      padding:12px;
      font-weight:800;
      line-height:1.5;
      border:1px solid var(--border);
      margin-bottom:12px;
    }
    .msg.err{ display:block; background:var(--danger-bg); border-color:#fecaca; color:var(--danger); }
    .msg.ok{ display:block; background:var(--success-bg); border-color:#bbf7d0; color:var(--success); }
    .msg.warn{ display:block; background:var(--warn-bg); border-color:#fde68a; color:#92400e; }

    .form{ display:grid; gap:12px; margin-top:10px; }

    label{ font-size:.85rem; font-weight:800; color:#475569; margin:0 0 6px; display:block; }
    .field{ display:grid; gap:6px; }

    .input{
      width:100%;
      border:1px solid #cbd5e1;
      border-radius:12px;
      padding:12px;
      font-size:.98rem;
      outline:none;
      background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(15,23,42,.10);
    }

    .pw-row{ display:flex; gap:10px; align-items:center; }
    .pw-row .input{ flex:1; }
    .pw-toggle{
      border:1px solid var(--border);
      background:#fff;
      color:var(--primary);
      padding:12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .pw-toggle:hover{ background:#f1f5f9; }

    .hint{
      margin-top:6px;
      color:var(--muted);
      font-weight:700;
      font-size:.92rem;
      line-height:1.6;
    }
    .hint strong{ color:var(--primary); }

    .btn{
      border:1px solid transparent;
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .12s ease, background .12s ease;
      width:100%;
      margin-top:12px;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-primary:hover{ background:#1e293b; }
    .btn-outline{ background:#fff; border-color:var(--border); color:var(--primary); margin-top:10px; }
    .btn-outline:hover{ background:#f1f5f9; }

    .token-box{
      margin-top:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid #e2e8f0;
      background:#f8fafc;
      color:#334155;
      font-weight:700;
      line-height:1.55;
    }
    .token-box code{
      display:block;
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #e2e8f0;
      background:#fff;
      font-weight:800;
      word-break:break-all;
      color:#0f172a;
    }
  </style>
</head>

<body>
  <!-- Shared navbar -->
  <div id="appNavbar"></div>

  <main class="wrap">
    <section class="card" aria-label="Reset password">
      <div class="badge"><i class="ph ph-shield-check"></i> Secure Reset</div>
      <h1>Reset your password</h1>
      <div class="sub">
        Create a new password for your account. This link is valid for a limited time.
      </div>

      <div id="msg" class="msg"></div>

      <form id="rpForm" class="form" novalidate>
        <div class="field">
          <label for="password">New password</label>
          <div class="pw-row">
            <input class="input" id="password" type="password" autocomplete="new-password" placeholder="Create a new password" required />
            <button class="pw-toggle" type="button" id="pwToggle" aria-label="Show/Hide password">
              <i class="ph ph-eye"></i>
            </button>
          </div>
          <div class="hint">Use at least <strong>8</strong> characters.</div>
        </div>

        <div class="field">
          <label for="confirm">Confirm new password</label>
          <input class="input" id="confirm" type="password" autocomplete="new-password" placeholder="Repeat new password" required />
        </div>

        <button class="btn btn-primary" id="btnReset" type="submit">
          <i class="ph ph-arrow-clockwise"></i> Reset password
        </button>

        <button class="btn btn-outline" type="button" onclick="window.location.href='login.html'">
          <i class="ph ph-sign-in"></i> Back to login
        </button>
      </form>

      <div class="token-box" id="tokenBox" style="display:none;">
        <div><strong>Missing token.</strong> Your reset link should look like:</div>
        <code>reset-password.html?token=YOUR_TOKEN</code>
        <div style="margin-top:8px;">
          Go back and request a new reset link from <strong>Forgot Password</strong>.
        </div>
      </div>
    </section>
  </main>

  <!-- Shared navbar script -->
  <script src="./assets/navbar.js"></script>

  <script>
    const API_BASE = (localStorage.getItem("API_BASE") || "https://inzulink-v1.onrender.com").replace(/\/$/, "");

    const msg = document.getElementById("msg");
    const btnReset = document.getElementById("btnReset");
    const form = document.getElementById("rpForm");
    const tokenBox = document.getElementById("tokenBox");

    function setMsg(type, text){
      msg.className = "msg " + type;
      msg.textContent = text;
    }
    function clearMsg(){
      msg.className = "msg";
      msg.textContent = "";
    }

    function passwordOk(p){ return p && p.length >= 8; }

    // Read token from URL (?token=...)
    const params = new URLSearchParams(window.location.search);
    const token = (params.get("token") || "").trim();

    if (!token) {
      tokenBox.style.display = "block";
      setMsg("warn", "Reset token is missing. Please request a new reset link.");
      // We still allow form typing, but it will error on submit.
    }

    // Toggle password visibility
    document.getElementById("pwToggle").addEventListener("click", () => {
      const pw = document.getElementById("password");
      pw.type = pw.type === "password" ? "text" : "password";
      document.getElementById("pwToggle").innerHTML =
        pw.type === "password" ? `<i class="ph ph-eye"></i>` : `<i class="ph ph-eye-slash"></i>`;
    });

    async function fetchWithTimeout(url, options = {}, timeoutMs = 12000){
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMsg();

      const password = (document.getElementById("password").value || "").trim();
      const confirm = (document.getElementById("confirm").value || "").trim();

      if (!token) return setMsg("err", "Missing reset token. Please request a new reset link.");
      if (!passwordOk(password)) return setMsg("err", "Password must be at least 8 characters.");
      if (password !== confirm) return setMsg("err", "Passwords do not match.");

      btnReset.disabled = true;
      btnReset.innerHTML = `<i class="ph ph-circle-notch"></i> Resetting...`;

      try {
        // NOTE: Choose endpoint name based on your backend.
        // If your backend uses /api/auth/reset-password, this will work.
        // If it uses /api/auth/reset, tell me and I’ll adjust.
        const res = await fetchWithTimeout(`${API_BASE}/api/auth/reset-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, password })
        }, 12000);

        let data = {};
        try { data = await res.json(); } catch(_) {}

        if (!res.ok) {
          setMsg("err", data.error || "Reset failed. The link may be expired. Request a new one.");
          btnReset.disabled = false;
          btnReset.innerHTML = `<i class="ph ph-arrow-clockwise"></i> Reset password`;
          return;
        }

        setMsg("ok", data.message || "Password reset successful. Redirecting to login...");
        setTimeout(() => window.location.href = "login.html", 900);

      } catch (err) {
        setMsg("warn", "Cannot reach server right now. Please try again.");
        btnReset.disabled = false;
        btnReset.innerHTML = `<i class="ph ph-arrow-clockwise"></i> Reset password`;
      }
    });
  </script>
</body>
</html>
